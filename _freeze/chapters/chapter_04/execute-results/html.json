{
  "hash": "eab83ee4499087c499e71c48bffbcbc8",
  "result": {
    "engine": "knitr",
    "markdown": "---\nexecute: \n  echo: true\n  eval: false\n  warning: false\n---\n\n\n# Visual exploration of duplicated genes across the Eukarya tree of life\n\nHere, we will describe the code to perform exploratory data analyses\non the duplicated gene frequencies in genomes from Ensembl instances.\n\nTo start, let's load the required data and packages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123) # for reproducibility\n\n# Load required packages\nlibrary(doubletrouble)\nlibrary(here)\nlibrary(ggtree)\nlibrary(tidyverse)\nlibrary(patchwork)\n\nsource(here(\"code\", \"utils.R\"))\nsource(here(\"code\", \"utils_visualization.R\"))\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n## Loading data\n\nFirst, we will load object the same list of metadata we've been using\nin other chapters.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load metadata\nload(here(\"products\", \"result_files\", \"metadata_all.rda\"))\n```\n:::\n\n\nWe will also need objects generated in previous chapters, namely:\n\n1. Species trees\n2. Duplicates per species (genes and gene pairs)\n3. BUSCO scores for genomes in each instance\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load BUSCO scores\nload(here(\"products\", \"result_files\", \"busco_scores\", \"fungi_busco_scores.rda\"))\nload(here(\"products\", \"result_files\", \"busco_scores\", \"protists_busco_scores.rda\"))\nload(here(\"products\", \"result_files\", \"busco_scores\", \"plants_busco_scores.rda\"))\nload(here(\"products\", \"result_files\", \"busco_scores\", \"metazoa_busco_scores.rda\"))\nload(here(\"products\", \"result_files\", \"busco_scores\", \"vertebrates_busco_scores.rda\"))\n\n# Load trees\nload(here(\"products\", \"result_files\", \"trees\", \"fungi_busco_trees.rda\"))\nload(here(\"products\", \"result_files\", \"trees\", \"protists_busco_trees.rda\"))\nload(here(\"products\", \"result_files\", \"trees\", \"plants_busco_trees.rda\"))\nload(here(\"products\", \"result_files\", \"trees\", \"metazoa_busco_trees.rda\"))\nload(here(\"products\", \"result_files\", \"trees\", \"vertebrates_busco_trees.rda\"))\n\n# Load duplicated genes\nload(here(\"products\", \"result_files\", \"fungi_duplicates_unique.rda\"))\nload(here(\"products\", \"result_files\", \"protists_duplicates_unique.rda\"))\nload(here(\"products\", \"result_files\", \"plants_duplicates_unique.rda\"))\nload(here(\"products\", \"result_files\", \"vertebrates_duplicates_unique.rda\"))\nload(here(\"products\", \"result_files\", \"metazoa_duplicates_unique.rda\"))\n\n# Load substitution rates for plants\nload(here(\"products\", \"result_files\", \"plants_kaks.rda\"))\n```\n:::\n\n\n## Visualizing the frequency of duplicated genes by mode\n\nNow, we will visualize the frequency of duplicated genes by mode for each \nspecies. For that, we will first convert the list of duplicates into a\nlong-formatted data frame, and clean tip labels in our species trees.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Rename tip labels of trees\ntree_fungi <- fungi_busco_trees$conc\ntree_fungi$tip.label <- gsub(\"\\\\.\", \"_\", tree_fungi$tip.label)\n\ntree_protists <- protists_busco_trees$conc\ntree_protists$tip.label <- gsub(\"\\\\.\", \"_\", tree_protists$tip.label)\n\ntree_plants <- plants_busco_trees$conc\ntree_plants$tip.label <- gsub(\"\\\\.\", \"_\", tree_plants$tip.label)\n\ntree_metazoa <- metazoa_busco_trees$conc\ntree_metazoa$tip.label <- gsub(\"\\\\.\", \"_\", tree_metazoa$tip.label)\n\ntree_vertebrates <- vertebrates_busco_trees$conc\ntree_vertebrates$tip.label <- gsub(\"\\\\.\", \"_\", tree_vertebrates$tip.label)\n\n# Get count tables\ncounts_fungi <- duplicates2counts(fungi_duplicates_unique)\ncounts_protists <- duplicates2counts(protists_duplicates_unique)\ncounts_plants <- duplicates2counts(plants_duplicates_unique)\ncounts_vertebrates <- duplicates2counts(vertebrates_duplicates_unique)\ncounts_metazoa <- duplicates2counts(metazoa_duplicates_unique)\n```\n:::\n\n\nNow, we will plot the trees with data for each Ensembl instance.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Fungi\np_fungi_tree <- plot_tree_taxa(\n    tree = tree_fungi, \n    metadata = metadata_all$fungi, \n    taxon = \"phylum\",\n    text_size = 2.5\n)\n\np_fungi <- wrap_plots(\n    # Plot 1: Species tree\n    p_fungi_tree,\n    # Plot 2: Duplicate relative frequency by mode\n    plot_duplicate_freqs(\n        counts_fungi |>\n            mutate(\n                species = factor(species, levels = rev(get_taxa_name(p_fungi_tree)))\n            ),\n        plot_type = \"stack_percent\"\n    ) +\n        theme(\n            axis.text.y = element_blank(),\n            axis.ticks.y = element_blank()\n        ) +\n        labs(y = NULL),\n    widths = c(1, 4)\n) +\n    plot_annotation(title = \"Fungi\") &\n    theme(plot.margin = margin(2, 0, 0, 2))\n\n# Protists\np_protists_tree <- plot_tree_taxa(\n    tree = tree_protists, \n    metadata = metadata_all$protists |>\n        filter(phylum != \"Evosea\"), \n    taxon = \"phylum\", \n    min_n_lab = 2,\n    padding_text = 0.2,\n    text_size = 2.5\n)\np_protists <- wrap_plots(\n    # Plot 1: Species tree\n    p_protists_tree,\n    # Plot 2: Duplicate relative frequency by mode\n    plot_duplicate_freqs(\n        counts_protists |>\n            mutate(\n                species = factor(species, levels = rev(get_taxa_name(p_protists_tree)))\n            ),\n        plot_type = \"stack_percent\") +\n        theme(\n            axis.text.y = element_blank(),\n            axis.ticks.y = element_blank()\n        ) +\n        labs(y = NULL),\n    widths = c(1, 4)\n) +\n    plot_annotation(title = \"Protists\") &\n    theme(plot.margin = margin(2, 0, 0, 2))\n\n\n# Plants\np_plants_tree <- plot_tree_taxa(\n    tree = tree_plants, \n    metadata = metadata_all$plants, \n    taxon = \"order\", \n    min_n_lab = 3,\n    text_size = 2.5\n)\np_plants <- wrap_plots(\n    # Plot 1: Species tree\n    p_plants_tree,\n    # Plot 2: Duplicate relative frequency by mode\n    plot_duplicate_freqs(\n        counts_plants |>\n            mutate(\n                species = factor(species, levels = rev(get_taxa_name(p_plants_tree)))\n            ),\n        plot_type = \"stack_percent\") +\n        theme(\n            axis.text.y = element_blank(),\n            axis.ticks.y = element_blank()\n        ) +\n        labs(y = NULL),\n    widths = c(1, 4)\n) +\n    plot_annotation(title = \"Plants\") &\n    theme(plot.margin = margin(2, 0, 0, 2))\n\n# Metazoa\np_metazoa_tree <- plot_tree_taxa(\n    tree = tree_metazoa, \n    metadata = metadata_all$metazoa |>\n        filter(class != \"Myxozoa\"), \n    taxon = \"phylum\", \n    min_n = 2, \n    text_size = 2.2, \n    padding_text = 2\n)\np_metazoa <- wrap_plots(\n    # Plot 1: Species tree\n    p_metazoa_tree,\n    # Plot 2: Duplicate relative frequency by mode\n    plot_duplicate_freqs(\n        counts_metazoa |>\n            mutate(\n                species = factor(species, levels = rev(get_taxa_name(p_metazoa_tree)))\n            ),\n        plot_type = \"stack_percent\") +\n        theme(\n            axis.text.y = element_blank(),\n            axis.ticks.y = element_blank()\n        ) +\n        labs(y = NULL),\n    widths = c(1, 4) \n) +\n    plot_annotation(title = \"Metazoa\") &\n    theme(plot.margin = margin(2, 0, 0, 2))\n\n# Vertebrates\np_vertebrates_tree <- plot_tree_taxa(\n    tree = tree_vertebrates, \n    metadata = metadata_all$ensembl |>\n        mutate(class = replace_na(class, \"Other\")), \n    taxon = \"class\", \n    min_n = 2, \n    text_size = 2.5\n)\np_vertebrates <- wrap_plots(\n    # Plot 1: Species tree\n    p_vertebrates_tree,\n    # Plot 2: Duplicate relative frequency by mode\n    plot_duplicate_freqs(\n        counts_vertebrates |>\n            mutate(\n                species = factor(species, levels = rev(get_taxa_name(p_vertebrates_tree)))\n            ),\n        plot_type = \"stack_percent\") +\n        theme(\n            axis.text.y = element_blank(),\n            axis.ticks.y = element_blank()\n        ) +\n        labs(y = NULL),\n    widths = c(1, 4)\n) +\n    plot_annotation(title = \"Vertebrates\") &\n    theme(plot.margin = margin(2, 0, 0, 2))\n\n# Combining all figures into one\np_duplicates_all_ensembl <- wrap_plots(\n    wrap_plots(\n        p_protists + \n            theme(legend.position = \"none\") + \n            labs(title = \"Protists\", x = NULL), \n        p_fungi + \n            theme(legend.position = \"none\") +\n            ggtitle(\"Fungi\"),\n        nrow = 2, heights = c(1, 2)\n    ), \n    p_plants + theme(legend.position = \"none\") + ggtitle(\"Plants\"), \n    p_metazoa + theme(legend.position = \"none\") + ggtitle(\"Metazoa (Invertebrates)\"), \n    p_vertebrates + ggtitle(\"Ensembl (Vertebrates)\"), \n    nrow = 1\n) +\n    plot_layout(axis_titles = \"collect\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np_duplicates_all_ensembl\n```\n\n::: {.cell-output-display}\n![](chapter_04_files/figure-html/unnamed-chunk-6-1.png){width=1536}\n:::\n:::\n\n\nBy visually comparing the Ensembl instances, we can see that plant genomes\nhave a much greater abundance of segmental duplicates, possibly due to \npervasive whole-genome duplication events. However, other major branches\nof the Eukarya tree of life also have particular species with a high proportion\nof SD-derived genes. Notably, while SD events are widespread in plants, \nvertebrate species with high proportions of SD-derived genes are concentrated\nin a particular branch (teleost fishes).\nTo investigate that, we will highlight species for which\nat least 20% of the duplicated genes derived from segmental duplications.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# For each Ensembl instance, show species with >=20% of genes derived from SD\n## Define helper function\nsd_abundant <- function(count_table, min = 20) {\n    \n    perc_table <- count_table |> \n        group_by(species) |> \n        mutate(percentage = (n / sum(n)) * 100) |> \n        ungroup() |> \n        filter(type == \"SD\", percentage >= min)\n    \n    return(perc_table)\n}\n\n# Get a table of SD-abundant species for each instance\nsd_abundant_spp <- bind_rows(\n    sd_abundant(counts_fungi) |> mutate(instance = \"fungi\"),\n    sd_abundant(counts_protists) |> mutate(instance = \"protists\"),\n    sd_abundant(counts_plants) |> mutate(instance = \"plants\"),\n    sd_abundant(counts_vertebrates) |> mutate(instance = \"vertebrates\"),\n    sd_abundant(counts_metazoa) |> mutate(instance = \"metazoa\")\n) |>\n    as.data.frame()\n```\n:::\n\n\nThen, let's summarize the frequencies (absolute and relative) in a table.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# How many species per instance?\nsd_abundant_spp |> \n    count(instance) |>\n    mutate(\n        percentage = n / c(\n            nrow(metadata_all$fungi),\n            nrow(metadata_all$metazoa),\n            nrow(metadata_all$plants),\n            nrow(metadata_all$protists),\n            nrow(metadata_all$ensembl)\n        ) * 100\n    )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     instance  n percentage\n1       fungi  2   2.857143\n2     metazoa  7   2.766798\n3      plants 94  63.087248\n4    protists  2   6.060606\n5 vertebrates 21   6.624606\n```\n\n\n:::\n:::\n\n\nOnce again, our findings highlight the abundance of large-scale duplications\nin plant genomes, as segmental duplications contributed to 20% of the \nduplicated genes in 94 species (63%). Next, let's print all \nSD-abundant species.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Show all species\nknitr::kable(sd_abundant_spp)\n```\n\n::: {.cell-output-display}\n\n\n|type |     n|species                                | percentage|instance    |\n|:----|-----:|:--------------------------------------|----------:|:-----------|\n|SD   |  2138|fusarium_oxysporum                     |   20.16030|fungi       |\n|SD   |   683|saccharomyces_cerevisiae               |   26.16858|fungi       |\n|SD   | 14351|emiliania_huxleyi                      |   43.78509|protists    |\n|SD   | 27661|paramecium_tetraurelia                 |   79.03369|protists    |\n|SD   | 22430|actinidia_chinensis                    |   72.54908|plants      |\n|SD   |  4357|ananas_comosus                         |   22.15048|plants      |\n|SD   |  5885|arabidopsis_halleri                    |   21.37202|plants      |\n|SD   |  7530|arabidopsis_thaliana                   |   33.29796|plants      |\n|SD   | 42997|avena_sativa_ot3098                    |   74.43306|plants      |\n|SD   | 63492|avena_sativa_sang                      |   79.22833|plants      |\n|SD   |  7461|brachypodium_distachyon                |   27.24285|plants      |\n|SD   | 48381|brassica_juncea                        |   69.66407|plants      |\n|SD   | 59918|brassica_napus                         |   63.31417|plants      |\n|SD   | 24314|brassica_oleracea                      |   44.30232|plants      |\n|SD   | 23541|brassica_rapa                          |   62.58907|plants      |\n|SD   | 19282|brassica_rapa_ro18                     |   49.29567|plants      |\n|SD   | 69355|camelina_sativa                        |   79.45628|plants      |\n|SD   | 15785|chenopodium_quinoa                     |   48.57371|plants      |\n|SD   |  3600|citrullus_lanatus                      |   22.76608|plants      |\n|SD   |  4084|coffea_canephora                       |   20.60545|plants      |\n|SD   |  3317|cynara_cardunculus                     |   20.20959|plants      |\n|SD   | 41246|digitaria_exilis                       |   75.51999|plants      |\n|SD   |  8809|dioscorea_rotundata                    |   32.30764|plants      |\n|SD   | 66262|echinochloa_crusgalli                  |   70.97016|plants      |\n|SD   | 13447|eragrostis_curvula                     |   27.40650|plants      |\n|SD   | 46488|eucalyptus_grandis                     |   75.45773|plants      |\n|SD   |  6846|ficus_carica                           |   30.61580|plants      |\n|SD   |  6747|galdieria_sulphuraria                  |   25.40573|plants      |\n|SD   | 36994|glycine_max                            |   72.19468|plants      |\n|SD   | 16290|gossypium_raimondii                    |   48.65882|plants      |\n|SD   | 13432|helianthus_annuus                      |   23.21425|plants      |\n|SD   |  9537|ipomoea_triloba                        |   35.65100|plants      |\n|SD   | 13096|juglans_regia                          |   34.16556|plants      |\n|SD   |  7374|kalanchoe_fedtschenkoi                 |   28.37900|plants      |\n|SD   |  6757|lactuca_sativa                         |   20.52178|plants      |\n|SD   |  5758|leersia_perrieri                       |   25.97321|plants      |\n|SD   | 16167|lupinus_angustifolius                  |   54.14448|plants      |\n|SD   | 22987|malus_domestica_golden                 |   62.58031|plants      |\n|SD   | 14278|manihot_esculenta                      |   52.81693|plants      |\n|SD   | 16170|musa_acuminata                         |   54.10017|plants      |\n|SD   |  4586|nymphaea_colorata                      |   20.98472|plants      |\n|SD   |  5092|oryza_barthii                          |   20.55464|plants      |\n|SD   |  5078|oryza_brachyantha                      |   23.83366|plants      |\n|SD   |  6054|oryza_glaberrima                       |   23.77567|plants      |\n|SD   |  5454|oryza_glumipatula                      |   21.46484|plants      |\n|SD   |  5847|oryza_punctata                         |   24.25437|plants      |\n|SD   |  5587|oryza_rufipogon                        |   21.24335|plants      |\n|SD   |  6096|oryza_sativa                           |   23.94344|plants      |\n|SD   |  6136|oryza_sativa_arc                       |   22.25769|plants      |\n|SD   |  6139|oryza_sativa_azucena                   |   22.19370|plants      |\n|SD   |  6186|oryza_sativa_chaomeo                   |   22.05583|plants      |\n|SD   |  6125|oryza_sativa_gobolsailbalam            |   22.38506|plants      |\n|SD   |  6207|oryza_sativa_ir64                      |   22.73876|plants      |\n|SD   |  6131|oryza_sativa_ketannangka               |   22.16238|plants      |\n|SD   |  6479|oryza_sativa_khaoyaiguang              |   23.36964|plants      |\n|SD   |  6144|oryza_sativa_larhamugad                |   22.46107|plants      |\n|SD   |  7212|oryza_sativa_lima                      |   25.41584|plants      |\n|SD   | 15680|oryza_sativa_liuxu                     |   43.62827|plants      |\n|SD   |  6044|oryza_sativa_mh63                      |   22.24512|plants      |\n|SD   |  6158|oryza_sativa_n22                       |   22.43270|plants      |\n|SD   |  6133|oryza_sativa_natelboro                 |   22.56688|plants      |\n|SD   |  6172|oryza_sativa_pr106                     |   22.42896|plants      |\n|SD   |  6084|oryza_sativa_zs97                      |   22.69810|plants      |\n|SD   |  6182|panicum_hallii                         |   25.04761|plants      |\n|SD   |  5920|panicum_hallii_fil2                    |   23.51633|plants      |\n|SD   | 19358|papaver_somniferum                     |   53.13169|plants      |\n|SD   |  8274|phaseolus_vulgaris                     |   35.38165|plants      |\n|SD   |  4494|physcomitrium_patens                   |   20.34221|plants      |\n|SD   | 19860|populus_trichocarpa                    |   64.67159|plants      |\n|SD   |  4340|prunus_persica                         |   20.51040|plants      |\n|SD   | 28231|saccharum_spontaneum                   |   60.01743|plants      |\n|SD   | 26322|selaginella_moellendorffii             |   78.55906|plants      |\n|SD   |  8274|sesamum_indicum                        |   40.09887|plants      |\n|SD   |  5474|setaria_italica                        |   20.87799|plants      |\n|SD   |  5966|setaria_viridis                        |   20.86525|plants      |\n|SD   |  6400|solanum_lycopersicum                   |   23.89486|plants      |\n|SD   |  5462|sorghum_bicolor                        |   21.38857|plants      |\n|SD   |  4707|theobroma_cacao                        |   21.34888|plants      |\n|SD   |  4700|theobroma_cacao_criollo                |   27.23059|plants      |\n|SD   | 79033|triticum_aestivum                      |   74.43304|plants      |\n|SD   | 84812|triticum_aestivum_arinalrfor           |   59.47838|plants      |\n|SD   | 83573|triticum_aestivum_jagger               |   60.03419|plants      |\n|SD   | 84383|triticum_aestivum_julius               |   60.38658|plants      |\n|SD   | 83838|triticum_aestivum_lancer               |   60.23148|plants      |\n|SD   | 84018|triticum_aestivum_landmark             |   60.46244|plants      |\n|SD   | 83797|triticum_aestivum_mace                 |   60.13290|plants      |\n|SD   | 84076|triticum_aestivum_mattis               |   60.28855|plants      |\n|SD   | 85143|triticum_aestivum_norin61              |   59.19326|plants      |\n|SD   | 78393|triticum_aestivum_refseqv2             |   74.92903|plants      |\n|SD   | 71709|triticum_aestivum_renan                |   72.46554|plants      |\n|SD   | 84481|triticum_aestivum_stanley              |   60.76589|plants      |\n|SD   | 39910|triticum_dicoccoides                   |   66.30559|plants      |\n|SD   | 79753|triticum_spelta                        |   71.15848|plants      |\n|SD   | 40003|triticum_turgidum                      |   61.74827|plants      |\n|SD   |  6408|vigna_angularis                        |   22.74437|plants      |\n|SD   |  5792|vigna_radiata                          |   31.59503|plants      |\n|SD   |  9733|vigna_unguiculata                      |   36.46001|plants      |\n|SD   | 12270|zea_mays                               |   36.60283|plants      |\n|SD   | 33441|carassius_auratus                      |   63.10337|vertebrates |\n|SD   |  3320|chelydra_serpentina                    |   20.89759|vertebrates |\n|SD   | 32958|cyprinus_carpio_carpio                 |   76.37476|vertebrates |\n|SD   | 32609|cyprinus_carpio_germanmirror           |   75.35298|vertebrates |\n|SD   | 29145|cyprinus_carpio_hebaored               |   65.96578|vertebrates |\n|SD   | 31855|cyprinus_carpio_huanghe                |   72.97322|vertebrates |\n|SD   |  7716|danio_rerio                            |   29.36073|vertebrates |\n|SD   |  4099|esox_lucius                            |   20.63220|vertebrates |\n|SD   |  4039|homo_sapiens                           |   21.22996|vertebrates |\n|SD   | 16593|hucho_hucho                            |   35.39387|vertebrates |\n|SD   | 27413|oncorhynchus_kisutch                   |   67.90775|vertebrates |\n|SD   | 30397|oncorhynchus_mykiss                    |   68.93838|vertebrates |\n|SD   | 27241|oncorhynchus_tshawytscha               |   68.78519|vertebrates |\n|SD   |  5961|paramormyrops_kingsleyae               |   29.53183|vertebrates |\n|SD   | 29770|salmo_salar                            |   67.73144|vertebrates |\n|SD   | 30000|salmo_trutta                           |   73.09585|vertebrates |\n|SD   |  8900|scleropages_formosus                   |   44.73936|vertebrates |\n|SD   | 30939|sinocyclocheilus_anshuiensis           |   73.04169|vertebrates |\n|SD   | 27003|sinocyclocheilus_grahami               |   63.16048|vertebrates |\n|SD   | 29952|sinocyclocheilus_rhinocerous           |   68.66260|vertebrates |\n|SD   |  3940|terrapene_carolina_triunguis           |   22.53231|vertebrates |\n|SD   | 13217|actinia_equina_gca011057435            |   34.55335|metazoa     |\n|SD   | 31761|adineta_vaga                           |   73.23265|metazoa     |\n|SD   | 12381|amphibalanus_amphitrite_gca019059575v1 |   49.10757|metazoa     |\n|SD   |  6049|caenorhabditis_brenneri                |   25.57825|metazoa     |\n|SD   |  8823|crassostrea_virginica_gca002022765v4   |   29.95213|metazoa     |\n|SD   |  4261|lytechinus_variegatus_gca018143015v1   |   24.31384|metazoa     |\n|SD   |  4906|strongylocentrotus_purpuratus          |   21.82579|metazoa     |\n\n\n:::\n:::\n\n\n## BUSCO scores\n\nNext, we will test whether the percentage of segmental duplicates in genomes\nis associated with the percentage of complete BUSCOs. In other words,\nwe want to find out whether the low percentages of SD gene pairs is due to\ngenome fragmentation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Define function to plot association between % SD and % complete BUSCOs\nplot_busco_sd_assoc <- function(busco_df, counts_table) {\n    \n    p <- busco_df |>\n        filter(Class %in% c(\"Complete_SC\", \"Complete_duplicate\")) |>\n        mutate(species = str_replace_all(File, \"\\\\.fa\", \"\")) |>\n        mutate(species = str_replace_all(species, \"\\\\.\", \"_\")) |>\n        group_by(species) |> \n        summarise(complete_BUSCOs = sum(Frequency)) |>\n        inner_join(sd_abundant(counts_table, min = 0)) |>\n        ggpubr::ggscatter(\n            x = \"complete_BUSCOs\", y = \"percentage\",\n            color = \"deepskyblue4\", alpha = 0.4,\n            add = \"reg.line\", add.params = list(\n                color = \"black\", fill = \"lightgray\"\n            ),\n            conf.int = TRUE,\n            cor.coef = TRUE,\n            cor.coeff.args = list(\n                method = \"pearson\", label.x = 3, label.sep = \"\\n\"\n            )\n        ) +\n        labs(x = \"% complete BUSCOs\", y = \"% SD duplicates\")\n    \n    return(p)\n}\n\n# Fungi\np_busco_association <- patchwork::wrap_plots(\n    plot_busco_sd_assoc(fungi_busco_scores, counts_fungi) + \n        labs(title = \"Fungi\"),\n    plot_busco_sd_assoc(plants_busco_scores, counts_plants) +\n        labs(title = \"Plants\"),\n    plot_busco_sd_assoc(protists_busco_scores, counts_protists) + \n        labs(title = \"Protists\"),\n    plot_busco_sd_assoc(metazoa_busco_scores, counts_metazoa) +\n        labs(title = \"Metazoa\"),\n    plot_busco_sd_assoc(vertebrates_busco_scores, counts_vertebrates) +\n        labs(title = \"Vertebrates\"),\n    nrow = 1\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np_busco_association\n```\n\n::: {.cell-output-display}\n![](chapter_04_files/figure-html/unnamed-chunk-11-1.png){width=1152}\n:::\n:::\n\n\nThere is weak or no association between the percentage of complete BUSCOs\nand the percentage of SD-derived genes.\n\n## Visualizing substitution rates for selected plant species\n\nHere, we will first visualize $K_s$ distributions for *Glycine max* and\n*Phaseolus vulgaris* by mode of duplication.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# G. max\ngmax_ks_distro <- plot_ks_distro(\n    plants_kaks$glycine_max, max_ks = 2, bytype = TRUE, binwidth = 0.03\n) +\n    labs(title = NULL, y = NULL)\n\n# P. vulgaris\npvu_ks_distro <- plot_ks_distro(\n    plants_kaks$phaseolus_vulgaris, max_ks = 2, bytype = TRUE, binwidth = 0.03\n) +\n    labs(title = NULL, y = NULL)\n\n\n# Combining plots\np_ks_legumes <- wrap_plots(\n    gmax_ks_distro + \n        labs(title = \"Glycine max\") +\n        theme(plot.title = element_text(face = \"italic\")), \n    pvu_ks_distro + \n        labs(title = \"Phaseolus vulgaris\") +\n        theme(plot.title = element_text(face = \"italic\")), \n    nrow = 1\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np_ks_legumes\n```\n\n::: {.cell-output-display}\n![](chapter_04_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\nThe plot shows the importance of visualizing Ks distributions by mode. \nWhen visualizing the whole-paranome distribution, detection of peaks is not \ntrivial, and potential whole-genome duplication events might be masked. When\nwe split the distribution by mode of duplication, we can more easily observe\nsegmental duplicates that cluster together, providing strong evidence for\nwhole-genome duplication events (2 events for *G. max*, and 1 events for\n*P. vulgaris*).\n\nNext, we will plot the distributions of $K_a$, $K_s$, and $K_a/K_s$ values \nfor selected plant species with phylogenetic context.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Subset plant tree to get selected species only\ntree_subset <- ape::keep.tip(tree_plants, names(plants_kaks))\n\n# Clean names\nnames(plants_kaks) <- gsub(\"_\", \" \", str_to_title(names(plants_kaks)))\ntree_subset$tip.label <- gsub(\"_\", \" \", str_to_title(tree_subset$tip.label))\n\n# Plot tree\np_tree_selected <- ggtree(tree_subset, branch.length = \"none\") +\n    geom_tiplab(fontface = \"italic\", size = 3)\n\n# Reoder rates list based on tree topology\nord <- rev(ggtree::get_taxa_name(p_tree_selected))\nrl <- plants_kaks[ord]\n\n# Plot rates by species with tree on the left\np_rates_phylogeny <- wrap_plots(\n    p_tree_selected + xlim(0, 10),\n    plot_rates_by_species(rl, rate_column = \"Ks\", range = c(0, 2)) +\n        theme(\n            axis.text.y = element_blank(),\n            axis.ticks.y = element_blank()\n        ),\n    plot_rates_by_species(\n        rl, rate_column = \"Ka\", range = c(0, 2), \n        fill = \"mediumseagreen\", color = \"seagreen\"\n    ) +\n        theme(\n            axis.text.y = element_blank(),\n            axis.ticks.y = element_blank()\n        ),\n    plot_rates_by_species(\n        rl, rate_column = \"Ka_Ks\", range = c(0, 2),\n        fill = \"darkorange2\", color = \"darkorange3\"\n    ) +\n        theme(\n            axis.text.y = element_blank(),\n            axis.ticks.y = element_blank()\n        ),\n    nrow = 1\n) +\n    plot_annotation(title = \"Substitution rates in a phylogenetic context\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np_rates_phylogeny\n```\n\n::: {.cell-output-display}\n![](chapter_04_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n## Saving objects {.unnumbered}\n\nFinally, let's save important objects created in this session for further use.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Save plots for each instance\nsave(\n    p_fungi, compress = \"xz\", \n    file = here(\"products\", \"plots\", \"p_fungi.rda\")\n)\n\nsave(\n    p_metazoa, compress = \"xz\", \n    file = here(\"products\", \"plots\", \"p_metazoa.rda\")\n)\n\nsave(\n    p_protists, compress = \"xz\", \n    file = here(\"products\", \"plots\", \"p_protists.rda\")\n)\n\nsave(\n    p_vertebrates, compress = \"xz\", \n    file = here(\"products\", \"plots\", \"p_vertebrates.rda\")\n)\n\nsave(\n    p_plants, compress = \"xz\", \n    file = here(\"products\", \"plots\", \"p_plants.rda\")\n)\n\nsave(\n    p_duplicates_all_ensembl, compress = \"xz\",\n    file = here(\"products\", \"plots\", \"p_duplicates_all_ensembl.rda\")\n)\n\nsave(\n    p_ks_legumes, compress = \"xz\",\n    file = here(\"products\", \"plots\", \"p_ks_legumes.rda\")\n)\n\nsave(\n    p_rates_phylogeny, compress = \"xz\",\n    file = here(\"products\", \"plots\", \"p_rates_phylogeny.rda\")\n)\n\nsave(\n    p_busco_association, compress = \"xz\",\n    file = here(\"products\", \"plots\", \"p_busco_association.rda\")\n)\n\n# Save tables\nsave(\n    sd_abundant_spp, compress = \"xz\",\n    file = here(\"products\", \"result_files\", \"sd_abundant_spp.rda\")\n)\n```\n:::\n\n\n## Session info {.unnumbered}\n\nThis document was created under the following conditions:\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n─ Session info ───────────────────────────────────────────────────────────────\n setting  value\n version  R version 4.3.2 (2023-10-31)\n os       Ubuntu 22.04.3 LTS\n system   x86_64, linux-gnu\n ui       X11\n language (EN)\n collate  en_US.UTF-8\n ctype    en_US.UTF-8\n tz       Europe/Brussels\n date     2024-02-27\n pandoc   3.1.1 @ /usr/lib/rstudio/resources/app/bin/quarto/bin/tools/ (via rmarkdown)\n\n─ Packages ───────────────────────────────────────────────────────────────────\n package              * version     date (UTC) lib source\n abind                  1.4-5       2016-07-21 [1] CRAN (R 4.3.2)\n ade4                   1.7-22      2023-02-06 [1] CRAN (R 4.3.2)\n AnnotationDbi          1.64.1      2023-11-03 [1] Bioconductor\n ape                    5.7-1       2023-03-13 [1] CRAN (R 4.3.2)\n aplot                  0.2.2       2023-10-06 [1] CRAN (R 4.3.2)\n backports              1.4.1       2021-12-13 [1] CRAN (R 4.3.2)\n Biobase                2.62.0      2023-10-24 [1] Bioconductor\n BiocFileCache          2.10.1      2023-10-26 [1] Bioconductor\n BiocGenerics           0.48.1      2023-11-01 [1] Bioconductor\n BiocIO                 1.12.0      2023-10-24 [1] Bioconductor\n BiocParallel           1.37.0      2024-01-19 [1] Github (Bioconductor/BiocParallel@79a1b2d)\n biomaRt                2.58.2      2024-01-30 [1] Bioconductor 3.18 (R 4.3.2)\n Biostrings             2.70.2      2024-01-28 [1] Bioconductor 3.18 (R 4.3.2)\n bit                    4.0.5       2022-11-15 [1] CRAN (R 4.3.2)\n bit64                  4.0.5       2020-08-30 [1] CRAN (R 4.3.2)\n bitops                 1.0-7       2021-04-24 [1] CRAN (R 4.3.2)\n blob                   1.2.4       2023-03-17 [1] CRAN (R 4.3.2)\n broom                  1.0.5       2023-06-09 [1] CRAN (R 4.3.2)\n cachem                 1.0.8       2023-05-01 [1] CRAN (R 4.3.2)\n car                    3.1-2       2023-03-30 [1] CRAN (R 4.3.2)\n carData                3.0-5       2022-01-06 [1] CRAN (R 4.3.2)\n cli                    3.6.2       2023-12-11 [1] CRAN (R 4.3.2)\n coda                   0.19-4.1    2024-01-31 [1] CRAN (R 4.3.2)\n codetools              0.2-19      2023-02-01 [4] CRAN (R 4.2.2)\n colorspace             2.1-0       2023-01-23 [1] CRAN (R 4.3.2)\n crayon                 1.5.2       2022-09-29 [1] CRAN (R 4.3.2)\n curl                   5.2.0       2023-12-08 [1] CRAN (R 4.3.2)\n DBI                    1.2.1       2024-01-12 [1] CRAN (R 4.3.2)\n dbplyr                 2.4.0       2023-10-26 [1] CRAN (R 4.3.2)\n DelayedArray           0.28.0      2023-10-24 [1] Bioconductor\n digest                 0.6.34      2024-01-11 [1] CRAN (R 4.3.2)\n doParallel             1.0.17      2022-02-07 [1] CRAN (R 4.3.2)\n doubletrouble        * 1.3.4       2024-02-05 [1] Bioconductor\n dplyr                * 1.1.4       2023-11-17 [1] CRAN (R 4.3.2)\n evaluate               0.23        2023-11-01 [1] CRAN (R 4.3.2)\n fansi                  1.0.6       2023-12-08 [1] CRAN (R 4.3.2)\n farver                 2.1.1       2022-07-06 [1] CRAN (R 4.3.2)\n fastmap                1.1.1       2023-02-24 [1] CRAN (R 4.3.2)\n filelock               1.0.3       2023-12-11 [1] CRAN (R 4.3.2)\n forcats              * 1.0.0       2023-01-29 [1] CRAN (R 4.3.2)\n foreach                1.5.2       2022-02-02 [1] CRAN (R 4.3.2)\n fs                     1.6.3       2023-07-20 [1] CRAN (R 4.3.2)\n generics               0.1.3       2022-07-05 [1] CRAN (R 4.3.2)\n GenomeInfoDb           1.38.6      2024-02-08 [1] Bioconductor 3.18 (R 4.3.2)\n GenomeInfoDbData       1.2.11      2023-12-21 [1] Bioconductor\n GenomicAlignments      1.38.2      2024-01-16 [1] Bioconductor 3.18 (R 4.3.2)\n GenomicFeatures        1.54.3      2024-01-31 [1] Bioconductor 3.18 (R 4.3.2)\n GenomicRanges          1.54.1      2023-10-29 [1] Bioconductor\n ggfun                  0.1.4       2024-01-19 [1] CRAN (R 4.3.2)\n ggnetwork              0.5.13      2024-02-14 [1] CRAN (R 4.3.2)\n ggplot2              * 3.4.4       2023-10-12 [1] CRAN (R 4.3.2)\n ggplotify              0.1.2       2023-08-09 [1] CRAN (R 4.3.2)\n ggpubr                 0.6.0.999   2024-02-09 [1] Github (kassambara/ggpubr@6aeb4f7)\n ggsignif               0.6.4       2022-10-13 [1] CRAN (R 4.3.2)\n ggtree               * 3.10.0      2023-10-24 [1] Bioconductor\n glue                   1.7.0       2024-01-09 [1] CRAN (R 4.3.2)\n gridGraphics           0.5-1       2020-12-13 [1] CRAN (R 4.3.2)\n gtable                 0.3.4       2023-08-21 [1] CRAN (R 4.3.2)\n here                 * 1.0.1       2020-12-13 [1] CRAN (R 4.3.2)\n hms                    1.1.3       2023-03-21 [1] CRAN (R 4.3.2)\n htmltools              0.5.7       2023-11-03 [1] CRAN (R 4.3.2)\n htmlwidgets            1.6.4       2023-12-06 [1] CRAN (R 4.3.2)\n httr                   1.4.7       2023-08-15 [1] CRAN (R 4.3.2)\n igraph                 2.0.1.1     2024-01-30 [1] CRAN (R 4.3.2)\n intergraph             2.0-4       2024-02-01 [1] CRAN (R 4.3.2)\n IRanges                2.36.0      2023-10-24 [1] Bioconductor\n iterators              1.0.14      2022-02-05 [1] CRAN (R 4.3.2)\n jsonlite               1.8.8       2023-12-04 [1] CRAN (R 4.3.2)\n KEGGREST               1.42.0      2023-10-24 [1] Bioconductor\n knitr                  1.45        2023-10-30 [1] CRAN (R 4.3.2)\n labeling               0.4.3       2023-08-29 [1] CRAN (R 4.3.2)\n lattice                0.22-5      2023-10-24 [4] CRAN (R 4.3.1)\n lazyeval               0.2.2       2019-03-15 [1] CRAN (R 4.3.2)\n lifecycle              1.0.4       2023-11-07 [1] CRAN (R 4.3.2)\n lubridate            * 1.9.3       2023-09-27 [1] CRAN (R 4.3.2)\n magrittr               2.0.3       2022-03-30 [1] CRAN (R 4.3.2)\n MASS                   7.3-60      2023-05-04 [4] CRAN (R 4.3.1)\n Matrix                 1.6-3       2023-11-14 [4] CRAN (R 4.3.2)\n MatrixGenerics         1.14.0      2023-10-24 [1] Bioconductor\n matrixStats            1.2.0       2023-12-11 [1] CRAN (R 4.3.2)\n mclust                 6.0.1       2023-11-15 [1] CRAN (R 4.3.2)\n memoise                2.0.1       2021-11-26 [1] CRAN (R 4.3.2)\n mgcv                   1.9-0       2023-07-11 [4] CRAN (R 4.3.1)\n MSA2dist               1.6.0       2023-10-24 [1] Bioconductor\n munsell                0.5.0       2018-06-12 [1] CRAN (R 4.3.2)\n network                1.18.2      2023-12-05 [1] CRAN (R 4.3.2)\n networkD3              0.4         2017-03-18 [1] CRAN (R 4.3.2)\n nlme                   3.1-163     2023-08-09 [4] CRAN (R 4.3.1)\n patchwork            * 1.2.0       2024-01-08 [1] CRAN (R 4.3.2)\n pheatmap               1.0.12      2019-01-04 [1] CRAN (R 4.3.2)\n pillar                 1.9.0       2023-03-22 [1] CRAN (R 4.3.2)\n pkgconfig              2.0.3       2019-09-22 [1] CRAN (R 4.3.2)\n png                    0.1-8       2022-11-29 [1] CRAN (R 4.3.2)\n prettyunits            1.2.0       2023-09-24 [1] CRAN (R 4.3.2)\n progress               1.2.3       2023-12-06 [1] CRAN (R 4.3.2)\n purrr                * 1.0.2       2023-08-10 [1] CRAN (R 4.3.2)\n R6                     2.5.1       2021-08-19 [1] CRAN (R 4.3.2)\n rappdirs               0.3.3       2021-01-31 [1] CRAN (R 4.3.2)\n RColorBrewer           1.1-3       2022-04-03 [1] CRAN (R 4.3.2)\n Rcpp                   1.0.12      2024-01-09 [1] CRAN (R 4.3.2)\n RCurl                  1.98-1.14   2024-01-09 [1] CRAN (R 4.3.2)\n readr                * 2.1.5       2024-01-10 [1] CRAN (R 4.3.2)\n restfulr               0.0.15      2022-06-16 [1] CRAN (R 4.3.2)\n rjson                  0.2.21      2022-01-09 [1] CRAN (R 4.3.2)\n rlang                  1.1.3       2024-01-10 [1] CRAN (R 4.3.2)\n rmarkdown              2.25        2023-09-18 [1] CRAN (R 4.3.2)\n rprojroot              2.0.4       2023-11-05 [1] CRAN (R 4.3.2)\n Rsamtools              2.18.0      2023-10-24 [1] Bioconductor\n RSQLite                2.3.5       2024-01-21 [1] CRAN (R 4.3.2)\n rstatix                0.7.2       2023-02-01 [1] CRAN (R 4.3.2)\n rstudioapi             0.15.0      2023-07-07 [1] CRAN (R 4.3.2)\n rtracklayer            1.62.0      2023-10-24 [1] Bioconductor\n S4Arrays               1.2.0       2023-10-24 [1] Bioconductor\n S4Vectors              0.40.2      2023-11-23 [1] Bioconductor 3.18 (R 4.3.2)\n scales                 1.3.0       2023-11-28 [1] CRAN (R 4.3.2)\n seqinr                 4.2-36      2023-12-08 [1] CRAN (R 4.3.2)\n sessioninfo            1.2.2       2021-12-06 [1] CRAN (R 4.3.2)\n SparseArray            1.2.4       2024-02-11 [1] Bioconductor 3.18 (R 4.3.2)\n statnet.common         4.9.0       2023-05-24 [1] CRAN (R 4.3.2)\n stringi                1.8.3       2023-12-11 [1] CRAN (R 4.3.2)\n stringr              * 1.5.1       2023-11-14 [1] CRAN (R 4.3.2)\n SummarizedExperiment   1.32.0      2023-10-24 [1] Bioconductor\n syntenet               1.4.0       2023-10-24 [1] Bioconductor\n tibble               * 3.2.1       2023-03-20 [1] CRAN (R 4.3.2)\n tidyr                * 1.3.1       2024-01-24 [1] CRAN (R 4.3.2)\n tidyselect             1.2.0       2022-10-10 [1] CRAN (R 4.3.2)\n tidytree               0.4.6       2023-12-12 [1] CRAN (R 4.3.2)\n tidyverse            * 2.0.0       2023-02-22 [1] CRAN (R 4.3.2)\n timechange             0.3.0       2024-01-18 [1] CRAN (R 4.3.2)\n treeio                 1.26.0      2023-10-24 [1] Bioconductor\n tzdb                   0.4.0       2023-05-12 [1] CRAN (R 4.3.2)\n utf8                   1.2.4       2023-10-22 [1] CRAN (R 4.3.2)\n vctrs                  0.6.5       2023-12-01 [1] CRAN (R 4.3.2)\n withr                  3.0.0       2024-01-16 [1] CRAN (R 4.3.2)\n xfun                   0.42        2024-02-08 [1] CRAN (R 4.3.2)\n XML                    3.99-0.16.1 2024-01-22 [1] CRAN (R 4.3.2)\n xml2                   1.3.6       2023-12-04 [1] CRAN (R 4.3.2)\n XVector                0.42.0      2023-10-24 [1] Bioconductor\n yaml                   2.3.8       2023-12-11 [1] CRAN (R 4.3.2)\n yulab.utils            0.1.4       2024-01-28 [1] CRAN (R 4.3.2)\n zlibbioc               1.48.0      2023-10-24 [1] Bioconductor\n\n [1] /home/faalm/R/x86_64-pc-linux-gnu-library/4.3\n [2] /usr/local/lib/R/site-library\n [3] /usr/lib/R/site-library\n [4] /usr/lib/R/library\n\n──────────────────────────────────────────────────────────────────────────────\n```\n\n\n:::\n:::\n",
    "supporting": [
      "chapter_04_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}